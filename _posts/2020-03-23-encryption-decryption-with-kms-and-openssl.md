---
layout: post
title: Encryption / Decryption with AWS KMS and OpenSSL
date: 2020-03-23 13:32:20 +0300
description: This article describes how you can provide an external party a KMS public key for them to use along OpenSSL to securely encrypt your data. 
img: open_ssl_kms.png # Add image post (optional)
fig-caption: # Add figcaption (optional)
tags: [AWS, KMS, Encryption, OpenSSL]
---

This article describes how you can provide an external party a KMS public key for them to use along OpenSSL to securely encrypt your data. 

## Requirements
You need to create a KMS Asymmetric key in AWS prior to running the next steps. 
Specify the follow parameters to create your key: 
- Key Type: Asymmetric
- Key usage: Encrypt and decrypt
- Key Spec: RSA 2048

## Steps 
1 - Send the public key to the third party
You can use the following command from an IAM user/role with permissions to create a file with public key material:

```
aws kms get-public-key --key-id <kid> --query PublicKey --output text --region us-east-1 | base64 -di | openssl rsa -pubin -inform DER -pubout -outform PEM -out pubkey.pem
```
OR you can just download the public key from the KMS console [1]. Once you have the file, you can send it to the third party.
pubkey.pem -> file in which public key is stored

2 - Upon receiving the public key, the third party has to first generate a random key that will be used to encrypt the data.
The following command will generate a 256 bit (32 byte) random key:

```
openssl rand -base64 32 > key.bin
```
key.bin -> file in which the random key is stored

3 - The third party encrypts the random key generated in step 2 with the public key sent in step 1.
We can do this in two ways, please see commands below.

```
# method 1: rsautl tool [2]
openssl rsautl -encrypt -oaep -inkey pubkey.pem -pubin -in key.bin -out key.bin.enc # key.bin.enc -> file that consists of encrypted random key with rsautl

# method 2: pkeyutl tool [3]
openssl pkeyutl -encrypt -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256 -in key.bin -pubin -inkey pubkey.pem -out keypke.bin.enc # keypke.bin.enc -> file that consists of encrypted random key with pkeyutl
```

Please note that in method 1, the default algorithm is RSA algorithm that is supported by KMS asymmetric keys. You can use method 2 if you want to select a particular algorithm, see list of supported algorithms in [3]. Also, I am using a terminal in MacOS and I am having issues with pkeyutl tool whereas service team was using linux box and the same command was working. So please test the above command and make sure the OS the third party is using before implementing this step.


4 - Third party encrypts the data using the random key generated in step 2
```
openssl enc -aes-256-cbc -salt -in DATA -out DATA.enc -pass file:./key.bin -pbkdf2
```
Here, I used the "AES-256-CBC" symmetric encryption algorithm. But the enc command in openssl supports multiple algorithms and you can find all of them and the syntax for this command in [4].

DATA -> file that consists of the data to be encrypted and sent to you
DATA.enc -> encrypted data file


5 - Third party has to send you the following two files and the algorithm used
- key.bin.enc OR keypke.bin.enc depending on which tool was used -> encrypted random key

- DATA.enc -> encrypted data file
- Algorithm used: AES-256-CBC with -aes-256-cbc flag


6 - You have to first decrypt [5] the random key (key.bin.enc OR keypke.bin.enc)
```
# method 1: rsautl
aws kms decrypt --key-id <kid> --encryption-algorithm RSAES_OAEP_SHA_1 --ciphertext-blob fileb://key.bin.enc --query Plaintext --output text --region us-east-1 | base64 -di > keyplaintext.bin

# method 2: pkeyutl
aws kms decrypt --key-id <kid> --encryption-algorithm RSAES_OAEP_SHA_256 --ciphertext-blob fileb://keypke.bin.enc --query Plaintext --output text --region us-east-1 | base64 -di > keyplaintext.bin
```

keyplaintext.bin -> file with random key generated by 3rd party in step 2 in plaintext form

7 - Decrypt DATA.enc with the random key from step 6
```
openssl enc -d -aes-256-cbc -in DATA.enc -out DATA_plaintext -pass file:./keyplaintext.bin -pbkdf2
```

You will have to use the algorithm sent by third party in step 5.
DATA_plaintext -> final data in plaintext form

Please note that, you have to perform the steps 1,6 and 7 whereas third party has to perform the steps 2,3,4 and 5.

## Troubleshooting

### Bad decrypt issue 

If you run into the following [error](https://stackoverflow.com/questions/34304570/how-to-resolve-the-evp-decryptfinal-ex-bad-decrypt-during-file-decryption) while decrypting your files: `digital envelope routines: EVP_DecryptFInal_ex: bad decrypt`. 
It could be due to one of the followings: 
1. Your OpenSSL versions between OS are incompatible, i.e. if you encrypt on a machine that uses OpenSSL 1.1.1 and decrypt on one using 1.0.2, you'll get this error. 
To solve it, you'll have to add the `-md sha256` to the decrypt command 7.
1. Your encryption happens on Windows and decryption on Unix, to solve this, you'll need to run `dos2unix keyplaintext.bin` before decrypting your data files. 
As this will convert your key to a UNIX like file. 